<!DOCTYPE html>
<html>
<head>
  <meta name=viewport content="initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="FoldApp Interface for Airbitz" />
  <meta charset=utf-8 />
  <title>FoldApp</title>
  <link rel="stylesheet" href="css/core.css">
</head>

<body>
  <div class="container-fluid">
  	<center>
	  	<h2 class="balance">Total Balance: <span class="balance-amt">$0.00</span></h1>
	  	<div class="row">
	  		<div class="col-md-12">
	  			<div class="card-barcode"></div>
	  		</div>
	  	</div>
	  	<h3 class="add-funds">Add Funds</h3>

	  	<div class="row">
	  		<div class="col-md-12">
		  		<button type="button" value="5" class="btn btn-info btn-lg btn-add add-first">$5</button> <!-- First button -->
		  		<button type="button" value="10" class="btn btn-info btn-lg btn-add add-second">$10</button> <!-- Second button -->
		  	</div>
		</div>

		<!-- Thrid button -->
		<div class="row">
			<div class="col-md-12">
		  		<button type="button" value="25" class="btn btn-info btn-lg btn-add add-third">$25</button>
		  	</div>
		</div>

		<h4 class="dashboard-bottom-buttons">Powered by <a href="https://foldapp.com">FoldApp</a></div>

  	</center>
  </div>

  <script src="js/abc.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript">
  fold_api = "https://api.foldapp.com/v1/";

  function updateWallet(wallet) {
  	//console.log("Wallet changed to: " + JSON.stringify(wallet));
  	Account.abWallet = wallet;
  }

  function sRequest(url, json, handleReponse) {
  	$.ajax({
	    headers: {
	        'Accept' : 'application/json',
	        'Content-Type' : 'application/json'
	    },
	    'type' : 'POST',
	    'url' : url,
	    'data' : JSON.stringify(json),
	    'dataType': 'json',
	    success : function(response) {
	    	handleReponse(response);
	    }
	}).fail(function(xhr, textStatus, error) {
		console.log("There was an error. Status: " + xhr.status);
		console.log(xhr.Message);
	});
  }

  var Account = {
  	exists: $.Deferred(),
  	logged_in: $.Deferred(),
  	create: function() {
  		console.log("Creating user.");
  		url = fold_api + "users";
	  	newAcc = {"users": [{
	  	  "random_username": true,
	  	  "random_password": true
	  	}]}
		sRequest(url, newAcc, function(r) {
			console.log(r);
			Account.username = r['users'][0]['username'];
			Account.pass = r['users'][0]['password'];
			Account.creds = {"users": [{
			  "username": Account.username,
			  "password": Account.pass
			}]};
			Airbitz.core.writeData("fold-username", Account.username);
			Airbitz.core.writeData("fold-pass", Account.pass);
			Account.exists.resolve();
		});
  	},
  	login: function() {
  		url = fold_api + "my/session";
  		console.log(Account.creds);
  		sRequest(url, Account.creds, function(r) {
  			//console.log("Logging in" + JSON.stringify(r));
  			Account.logged_in.resolve(r);
  		});
  	},
  	updateBalance: function() {
  		this.getInfo("balances?currency=USD", function(balances) {
  			console.log("Balance: " + JSON.stringify(balances["balances"][0]["amount"]));
  			$(".balance-amt").text("$" + balances["balances"][0]["amount"]);
  		});
  	},
  	getInfo: function(info, handleReponse, root) {
  		root = typeof a !== 'undefined' ? a : "my/";
  		$.get(fold_api + root + info).done(function(response) {
  			handleReponse(response);
  		});
  	},
  	purchaseCard: function(denomination, brand_id) {
  		brand_id = typeof a !== 'undefined' ? a : "Starbucks";
  		newOrder = { "orders": [{
		    "brand_id": String(brand_id),
		    "value": { "amount": String(denomination), "currency": "USD" },
		    "price": { "currency": "BTC" },
		    "approved": true
		  }],
		  "cancel_all_others": true
		}
  		url = fold_api + "my/orders";
  		console.log("Getting new order");
  		sRequest(url, newOrder, function(r) {
			console.log("Order: " + JSON.stringify(r));
			amt = (r["orders"][0]["price"]["amount"] * 100000000);
			toAddr = r["orders"][0]["payment"][0]["address"];
			console.log("Spending " + amt + " from wallet: " + user.abWallet + " to: " + toAddr);
			console.log("Fiat amt: " + denomination)
			Airbitz.core.requestSpend(Account.abWallet,
				toAddr, amt, denomination, {
	        	label: 'FoldApp',
	        	category: 'Expense:Coffee',
	        	notes: "Purchased a $" + String(denomination) + " "
	        	+ String(brand_id) + " gift card."
	        });
  		});
  	},
  	approveOrder: function(order_id) { // Manually Approve an order
  		cOrder = {"orders": [{
		  "id": String(order_id),
		  "approved": true
		}]}
  		sRequest(fold_api + "my/orders", cOrder, function(r) {
  			console.log("Approving order");
  			console.log(r);
  		});
  	}
  }
  // Main
  var user = Object.create(Account);

  Airbitz.core.selectedWallet({
          success: updateWallet,
          error: function() {
          	console.log("Could not get selected wallet");
          }
        });
  Airbitz.core.setWalletChangeListener(updateWallet);
  //Airbitz.core.clearData(); fold-2015-11-18-JszcOVECE0iHn5
  Account.username = Airbitz.core.readData("fold-username");
  Account.pass = Airbitz.core.readData("fold-pass");

  if(!(typeof Account.username === 'undefined')) {
  	Account.creds = {"users": [{
			  "username": Account.username,
			  "password": Account.pass
			}]};
	console.log("User pulled from memory.");
	user.exists.resolve();
  } else {
  	user.create();
  }

  $.when(user.exists).done(function(data) {
  	user.login();
  });
  $.when(user.logged_in).done(function(data) {
  	user.updateBalance();
  	user.getInfo("cards", function(response) {
  		id = response["cards"][0]["id"];
  		console.log(id);
		$(".card-barcode").prepend('<img class="barcode" src="' + fold_api + "my/cards/" + id + "/barcode/png" + '"/>');
  	});
  	user.getInfo("profile", function(response) {
  		console.log(response["logged_in"]);
  		user.getInfo("orders", function(response) {
  			console.log(response);
  		});
  		// Done loading.
  	});
  });

  $(".btn-add").click(function() {
  	user.purchaseCard($(this).attr("value"));
  });


  </script>
</body>
</html>


