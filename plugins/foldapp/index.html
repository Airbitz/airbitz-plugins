<!DOCTYPE html>
<html>
<head>
  <meta name=viewport content="initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="FoldApp Interface for Airbitz" />
  <meta charset=utf-8 />
  <link rel="stylesheet" href="css/core.css">
  <!-- Basic stylesheet -->
<link rel="stylesheet" href="vendors/owl-carousel/owl.carousel.css">
 <!-- Default Theme -->
<link rel="stylesheet" href="vendors/owl-carousel/owl.theme.css">

<style type="text/css">
	<!--
	body {margin:10px}
	.add-funds-header {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:16pt; color: #007aFF; height: 70px}
	.title-header     {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:16pt; color: #555555; padding-top: 10px; padding-bottom: 0px}
	.title-header-2   {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:16pt; color: #555555; padding-bottom: 5px}
	.card-number      {font-family: Courier, serif; font-size:11pt; color: #555555}
	.card-balance     {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:11pt; color: #555555; padding-top: 5px}
	.card-balance-amt {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:20pt; color: #555555; padding-bottom: 10px}
	.card-value       {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:18pt; color: #555555; height: 50px}
	.collapsible-header {vert-align: middle}
	.buy-card         {
		background-color: #FFFFFF;
		-moz-border-radius: 10px;
		-webkit-border-radius: 10px;
		border: 1px solid #007aFF;
		color: #007aFF;
		padding-top: 3.5px;
		padding-bottom: 3.5px;
		padding-left: 9px;
		padding-right: 9px;
		font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:12pt;
	}
	-->
</style>

	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="css/materialize.css"  media="screen,projection"/>
<template id="card-template">
	<div class="row">
		<div class="col s12 m7">
			<div class="item card">
			  			<div class="card-image">
			  				<div class="card-barcode"></div>
			  			</div>
			  	<div class="card-content card-info-main">
		  			<h5><div class="card-number"></div></h5>
		  			<div class="card-balance">
		  				<h4>Card Balance<br><span class="card-balance-amt"></span>
		  				<i class="material-icons right activator">info_outline</i></h4>
		  			</div>
				</div>
				<div class="card-reveal">
					<span class="card-title grey-text text-darken-4 center-align">Card Info<i class="material-icons right">close</i></span>
					<button class="refund waves-effect waves-light btn center-align">Refund</button>
				</div>
			</div>
		</div>
	</div>
</template>
<template id="add-template">
	<li class="collection-item avatar card-list">
		<span class="title"><h4 class="card-value" value=""></h4></span>
		<div class="secondary-content">
			<button type="button" class="buy-card btn-floating btn-large waves-effect waves-light green"><i class="material-icons medium">add</i></button>
		</div>
	</li>
</template>
</head>
<body>
	<div class="container-fluid">
		<h3 class="text-center fold-loading">
	    	<i class="fa fa-spinner fa-spin"></i> Loading
	    	<div class="fold-loading-spin">
		    	<div class="preloader-wrapper big active">
			        <div class="spinner-layer spinner-blue-only">
			          <div class="circle-clipper left">
			            <div class="circle"></div>
			          </div><div class="gap-patch">
			            <div class="circle"></div>
			          </div><div class="circle-clipper right">
			            <div class="circle"></div>
			          </div>
			        </div>
		    	</div>
			</div>
	    </h3>
	  	<center class="main">
	  		<header>
				<img src="https://airbitz.co/go/wp-content/uploads/2015/11/starbucks-96.png">
			</header>
			<main>
			  	<div id="user-cards" class="owl-carousel owl-theme">
			  		
			  	</div>
			  	<div class="add-funds">
	  			<ul class="collapsible" data-collapsible="accordion">
	  				<li>
	  		  			<div class="collapsible-header active">
	  				        <div class="add-funds-header">Add Funds</div>
	  				    </div>
	  				    <div class="collapsible-body">
	  				    	<ul class="collection add-buttons">

	  				    	</ul>
	  				    </div>
	  		  		</li>
	  			</ul>
					  	<!-- <div class="row">
					  		<div class="col-md-12">
						  		<button type="button" value="5" class="btn btn-info btn-lg btn-add add-first">$5</button> 
						  		<button type="button" value="10" class="btn btn-info btn-lg btn-add add-second">$10</button> 
						  	</div>
						</div>
						<div class="row">
							<div class="col-md-12">
						  		<button type="button" value="25" class="btn btn-info btn-lg btn-add add-third">$25</button>
						  	</div>
						</div> -->
				</div>
			</main>
			<footer>
				<div class="container">
					<div class="row">
						<div class="col l6 s12">
							<h6>Powered by Fold</h6>
							<h6>This application is not affiliated with the Starbucks Corporation</h6>
						</div>
					</div>
				</div>
			</footer>
	  	</center>
	</div>

  <script src="js/abc.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="js/materialize.min.js"></script>
  <script src="vendors/owl-carousel/owl.carousel.js" type="text/javascript"></script>
<script type="text/javascript">
var fold_api = "https://api.foldapp.com/v1/";
var brand = Airbitz.config.get("BRAND");

document.title = brand;

function toggleUi() {
	$(".fold-loading").css("display", "none");
	$(".main").css("display", "inline");
}

function supportsTemplate() {
  return 'content' in document.createElement('template');
}

function supportsImports() {
  return 'import' in document.createElement('link');
}
if (supportsTemplate()) {
  console.log("Does support templates!");
} else {
  // Use old templating techniques or libraries.
  console.log("Does not support templates.");
}
if (supportsImports()) {
  // Good to go!
  console.log("Supports imports!");
} else {
  // Use other libraries/require systems to load files.
  console.log("Does not support imports.");
}

function updateWallet(wallet) {
	//console.log("Wallet changed to: " + JSON.stringify(wallet));
	Account.abWallet = wallet;
}

function sRequest(url, json, handleReponse) {
	$.ajax({
    headers: {
        'Accept' : 'application/json',
        'Content-Type' : 'application/json'
    },
    'type' : 'POST',
    'url' : url,
    'data' : JSON.stringify(json),
    'dataType': 'json',
    success : function(response) {
    	handleReponse(response);
    }
}).fail(function(xhr, textStatus, error) {
	console.log("There was an error. Status: " + xhr.status);
	console.log(xhr.Message);
});
}

var Account = {
	exists: $.Deferred(),
	logged_in: $.Deferred(),
	all_cards: [],
	create: function() {
		console.log("Creating user.");
		url = fold_api + "users";
  	newAcc = {"users": [{
  	  "random_username": true,
  	  "random_password": true
  	}]}
	sRequest(url, newAcc, function(r) {
		//console.log(r);
		Account.username = r['users'][0]['username'];
		Account.pass = r['users'][0]['password'];
		Account.creds = {"users": [{
		  "username": Account.username,
		  "password": Account.pass
		}]};
		Airbitz.core.writeData("fold-username", Account.username);
		Airbitz.core.writeData("fold-pass", Account.pass);
		Account.exists.resolve();
	});
	},
	login: function() {
		url = fold_api + "my/session";
		console.log(Account.creds);
		sRequest(url, Account.creds, function(r) {
			//console.log("Logging in" + JSON.stringify(r));
			Account.logged_in.resolve(r);
		});
	},
	updateBalance: function() {
		this.getInfo("balances?currency=USD", function(balances) {
			console.log("Balance: " + JSON.stringify(balances["balances"][0]["amount"]));
			$(".balance-amt").text("$" + balances["balances"][0]["amount"]);
		});
	},
	updateCards: function() { // Updates the UI with cards the user has purchased.
		user.getInfo("cards", function(all_card_info) {
			console.log("User's cards: " + JSON.stringify(all_card_info));
			cards = all_card_info["cards"];
			document.querySelector("#user-cards").innerHTML = "";
			for(numOfCards in cards) {
				//console.log("Number of cards: " + numOfCards);
				card = new Card(
					cards[numOfCards]["id"],
					cards[numOfCards]["code"][0],
					cards[numOfCards]["balance"][0]["formatted"]["fewer_trailing_zeros"] // e.g. $5
				);
				Account.all_cards[numOfCards] = card;
				setInterval(Account.pingCards, 5000);
				//console.log("Card " + card.id + " has card num, " + card_num);
				var card_html = document.querySelector('#card-template').content;
				
				card_html.querySelector(".card-barcode").innerHTML = "<img class=\"barcode materialboxed\" src=\"" + fold_api + "my/cards/" + card.id + "/barcode/png" + "\">";
				card_html.querySelector(".card-balance-amt").innerText = card.bal;
				card_html.querySelector(".card-number").innerText = card.num;
				document.querySelector("#user-cards").appendChild( document.importNode(card_html, true) );
				$('.materialboxed').materialbox();
			}
			$("#user-cards").owlCarousel({ // Activate owl Carousel for cards.
			    //navigation : true, // Show next and prev buttons
			    slideSpeed : 300,
			    paginationSpeed : 400,
			    singleItem:true
			
			    // "singleItem:true" is a shortcut for:
			    // items : 1,
			    // itemsDesktop : false,
			    // itemsDesktopSmall : false,
			    // itemsTablet: false,
			    // itemsMobile : false
			});
			
		});
	},
	pingCards: function() {
		for(numOfCards in Account.all_cards) {
			Account.all_cards[numOfCards].ping();
		}
	},
	listCards: function() { // Updates the UI with cards avaliable to purchase from Fold.
		this.getInfo("brands", function(cards_avil) {
			var all_brands = cards_avil["brands"];
			var brands_cards = "";
			for(numOfbrands in all_brands) {
				if(all_brands[numOfbrands]["id"] == brand) {
					brands_cards = all_brands[numOfbrands];
					break;
				}
			}
			console.log(JSON.stringify(brands_cards["card_values"]));
			user.getBal(function(total_bal) {
				user.total_bal = total_bal;
				console.log("User bal: " + user.total_bal);
				console.log("Max: " + JSON.stringify(brands_cards["soft_max_total"][0]["amount"]));
				if(brands_cards["soft_max_total"][0]["amount"] >= user.total_bal) {
					var card_vals = brands_cards["card_values"];
					document.querySelector(".add-buttons").innerHTML = "";
					for(numOfVals in card_vals) {
						console.log("Listing card " + numOfVals);
						var add_html = document.querySelector('#add-template').content;
						add_html.querySelector(".card-value").setAttribute("value", card_vals[numOfVals]["amount"]);
						add_html.querySelector(".card-value").innerText = card_vals[numOfVals]["formatted"]["all_decimal_places"];
						document.querySelector(".add-buttons").appendChild(document.importNode(add_html,true));
					}
					$(".buy-card").click(function() {
				  		user.purchaseCard($(this).parent().parent().find(".card-value").attr("value"));
					});
				}
			});
		}, "");
	},
	getInfo: function(info, handleResponse, root) {
		root = typeof root !== 'undefined' ? root : "my/";
		$.get(fold_api + root + info).done(function(response) {
			handleResponse(response);
		});
	},
	getBal: function(handleResponse) { // Get total balance of user. Return 0 if user doesn't have bal.
		this.getInfo("balances?currency=USD", function(balances) {
			console.log(balances);
			try {
				handleResponse(balances["balances"][0]["amount"]);	
			}
			catch(err) {
				handleResponse(0);
			}
		});
	},
	purchaseCard: function(denomination, brand_id) {
		brand_id = typeof a !== 'undefined' ? a : brand;
		newOrder = { "orders": [{
	    "brand_id": String(brand_id),
	    "value": { "amount": String(denomination), "currency": "USD" },
	    "price": { "currency": "BTC" },
	    "approved": true
	  }],
	  "cancel_all_others": true
	}
		url = fold_api + "my/orders";
		console.log("Getting new order");
		sRequest(url, newOrder, function(r) {
			console.log("Order: " + JSON.stringify(r));
			amt = (r["orders"][0]["price"]["amount"] * 100000000);
			toAddr = r["orders"][0]["payment"][0]["address"];
			console.log("Spending " + amt + " from wallet: " + user.abWallet + " to: " + toAddr);
			console.log("Fiat amt: " + denomination)
			Airbitz.core.requestSpend(Account.abWallet,
				toAddr, amt, denomination, {
	        	label: 'Fold',
	        	category: 'Expense:Coffee Shops',
	        	notes: brand + " $" + String(denomination) + " gift card.",
	        	success: function(rawtx) {
	        		console.log("Funds were sent.");
	        		$(".balance-amt").prepend("Loading...");
	        		setTimeout(function() {
	        			user.updateCards();
	        			user.updateBalance();
	        		}, 5000);
	        	},
	        	error: function() {
	        		console.log("Funds were not sent.");
	        	}
	        });
		});
	},
	approveOrder: function(order_id) { // Manually Approve an order
		cOrder = {"orders": [{
	  				"id": String(order_id),
	  				"approved": true
				}]}
		sRequest(fold_api + "my/orders", cOrder, function(r) {
			console.log("Approving order");
			//console.log(r);
		});
	}
}

function Card(id, num, bal) {
	this.id = id;
	this.num = num;
	this.bal = bal;
}
Card.prototype.ping = function() {
	console.log("Pinging card.");
	var url = fold_api + "my/cards/" + this.id + "/ping";
	console.log(url);
	$.post(url);
}
Card.prototype.update = function() {

}

// Main
var user = Object.create(Account);

Airbitz.core.selectedWallet({
      success: updateWallet,
      error: function() {
      	console.log("Could not get selected wallet");
      }
    });
Airbitz.core.setWalletChangeListener(updateWallet);
//Airbitz.core.clearData(); fold-2015-11-18-JszcOVECE0iHn5
Account.username = Airbitz.core.readData("fold-username");
Account.pass = Airbitz.core.readData("fold-pass");

if(!(typeof Account.username === 'undefined' || Account.username == null)) {
	Account.creds = {"users": [{
		  "username": Account.username,
		  "password": Account.pass
		}]};
	console.log("User pulled from memory.");
	user.exists.resolve();
} else {
	user.create();
}
$.when(user.exists).done(function(data) {
	user.login();
});
$(function() {
	$.when(user.logged_in).done(function(data) {
		console.log("Updating UI");
		user.listCards(); // Start getting avaliable cards for sale.
		user.updateCards();
		// user.updateBalance();
		user.getInfo("profile", function(response) {
			//console.log(response);
			//console.log(response["logged_in"]);
			user.getInfo("orders", function(response) {
				//console.log(response);
			});
		// Done loading.
		toggleUi();
		});
	});
});

</script>
</body>
</html>


